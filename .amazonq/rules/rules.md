# üìã Regras de Desenvolvimento ‚Äî **CLI Tools v2.3 (duas vias, PT‚ÄëBR)**

> Objetivo: **velocidade com seguran√ßa**. Agora h√° duas vias de trabalho: **Via R√°pida** (mudan√ßas pequenas/baixo risco, **sem PR por padr√£o**) e **Via Completa** (mudan√ßas m√©dias/grandes). Abertura de PR s√≥ quando **solicitado** ou quando for **atualiza√ß√£o grande**.

---

## 1. Duas vias de fluxo

### üöÄ Via R√°pida (pequena/baixo risco)

Use quando **todas** as condi√ß√µes forem verdadeiras:

* At√© **2 arquivos** alterados **e** at√© **¬±20 linhas** no total.
* Mudan√ßa **local** (ex.: texto/label/estilo de bot√£o, pequeno handler, c√≥pia, layout pontual).
* **Sem** altera√ß√£o de contratos/API, migrations, seguran√ßa, performance cr√≠tica, scripts de deploy, workflows, libs core, componentes compartilhados sens√≠veis.
* **Sem** mudan√ßas em `.github/` nem em `.amazonq/` (exceto o **Di√°rio**).

**Fluxo (curto):**

1. **üíæ Commit checkpoint** em `dev`.
2. **üîé Mini‚Äëinvestiga√ß√£o** (1‚Äì3 linhas) + **Miniplano** (1‚Äì3 linhas).
3. **‚ùì Sinal verde r√°pido**: *‚ÄúMudan√ßa pequena (via r√°pida). Posso prosseguir? ‚úÖ/‚ùå‚Äù*.
4. **‚úÖ Implementar** o miniplano.
5. **üß™ Quick‚Äëcheck** local (`.amazonq/scripts/quick_check.sh`).
6. **üìù Di√°rio** atualizado.
7. **üîï PR**: **n√£o abrir** por padr√£o. Abra **somente se solicitado** pelo operador/gerente **ou** se a mudan√ßa deixar de ser pequena.
8. (Opcional, se solicitado) **Teste do operador**: fornecer passos curtos; aguardar **‚Äú‚úÖ testado ok‚Äù**.

> **Exemplo**: ‚ÄúAtualizar texto e √≠cone do bot√£o ‚ÄòSalvar‚Äô em `src/ui/Button.tsx`‚Äù ‚Üí **Via R√°pida**.

---

### üß± Via Completa (m√©dia/alta)

Qualquer item abaixo **ativa** a Via Completa:

* > 2 arquivos ou >¬±20 linhas; envolve **componentes compartilhados**, **m√∫ltiplos m√≥dulos** ou **refactor**.
* Altera **API/contratos**, **migrations**, **seguran√ßa** (auth/segredos), **desempenho cr√≠tico**.
* Modifica **workflows** (`.github/`), **deploy**, **infra**, **scripts**.
* Solicita√ß√£o expl√≠cita para abrir PR.

**Fluxo (completo):**

1. **üíæ Checkpoint** em `dev` ‚Üí 2) **Investigar** ‚Üí 3) **Plano**
2. **üõë Aprova√ß√£o**: *‚ÄúPosso prosseguir? ‚úÖ/‚ùå‚Äù* ‚Üí 5) **‚úÖ Executar**
3. **üìù Di√°rio** ‚Üí 7) **üß™ Teste (plano claro) e valida√ß√£o do operador** ‚Üí 8) **üîÄ Abrir PR** `dev`‚Üí`main` (**somente aqui**)
4. **ü§ñ CI/Auto‚Äëmerge** (squash quando verde) ‚Üí 10) **üîé Verifica√ß√£o p√≥s‚Äëmerge (GH CLI)**
5. **üìÑ Resumo curto** do que foi feito.

---

## 2) Itens **Nunca Fazer** / **Sempre Fazer**

**‚ùå Nunca**

* Implementar sem aprova√ß√£o (Via R√°pida tem aprova√ß√£o curta, mas **tem** gate).
* Pular etapas da via escolhida.
* Alterar arquivos **enquanto explica** o plano.
* Deixar artefatos tempor√°rios versionados.

**‚úÖ Sempre**

* Commit checkpoint **antes** de qualquer altera√ß√£o.
* Investigar (mesmo que breve na Via R√°pida).
* Atualizar o **Di√°rio de Bordo** ao final.
* **SSH** para clone (nunca HTTPS).
* Usar `scratch/` (git‚Äëignored) para rascunhos/POCs.

**Di√°rio:** `/home/desk/cli-tools/.amazonq/rules/diario_de_bordo.md`

Formato:

```markdown
### YYYY-MM-DD - T√≠tulo da Task ‚úÖ
- **Problema:** ...
- **Solu√ß√£o:** ...
- **Arquivos:** ...
- **Resultado:** ...
- **Pr√≥ximo:** ...
```

---

## 3) Pol√≠tica **machine‚Äëreadable** (para agents) ‚Äî `.amazonq/rules/rules.yaml`

```yaml
versao: 2.3
vias:
  rapida:
    max_arquivos: 2
    max_linhas_totais: 20
    require_pr: false
    require_teste_operador: false
    permitido:
      - ui/texto/estilo pontual
      - pequenos handlers locais
    proibido:
      - api/contratos
      - migrations
      - seguranca/segredos
      - desempenho_critico
      - workflows/.github
      - deploy/infra/scripts
      - componentes_compartilhados
  completa:
    require_pr: true
    require_teste_operador: true
    label_pr: "lane: full"

aprovacao:
  tokens:
    - "‚úÖ"
    - "aprovado"
  teste_tokens:
    - "‚úÖ testado ok"
    - "aprovado para PR"

comportamento_agent:
  respostas:
    - "## Investiga√ß√£o"
    - "## Plano"
    - "## Pedido de aprova√ß√£o: Posso prosseguir? ‚úÖ/‚ùå"
    - "## Plano de Testes (se via completa ou se solicitado)"
    - "## Pedido de aprova√ß√£o de testes: Pronto para testar? ‚úÖ/‚ùå (via completa)"
  hard_stop:
    antes_de_executar: true
    antes_de_abrir_pr: true

convencoes:
  diario: 
    - ".amazonq/rules/diario_de_bordo.md"
  scratch:
    - "scratch/"
  code_globs:
    - "**/*.py"
    - "**/*.ts"
    - "**/*.tsx"
    - "**/*.js"
    - "**/*.sh"
    - "**/*.go"
    - "**/*.rs"
```

> **Como o agent decide a via**: se exceder limites ou cair em proibidos ‚Üí **Completa**. Caso contr√°rio ‚Üí **R√°pida** (sem PR por padr√£o). Sempre pedir sinal verde curto.

---

## 4) Automa√ß√£o de **enforcement**

### 4.1 Pre‚Äëcommit ‚Äî `.amazonq/.pre-commit-config.yaml`

```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      - id: check-merge-conflict
      - id: end-of-file-fixer
      - id: trailing-whitespace
  - repo: https://github.com/psf/black
    rev: 24.4.2
    hooks:
      - id: black
        language_version: python3
  - repo: https://github.com/charliermarsh/ruff-pre-commit
    rev: v0.5.5
    hooks:
      - id: ruff
  - repo: https://github.com/pre-commit/pygrep-hooks
    rev: v1.10.0
    hooks:
      - id: text-unicode-replacement-char
  - repo: local
    hooks:
      - id: forbid-https-github
        name: proibir https do github (use SSH)
        entry: bash -c 'if git grep -n "https://github.com/" -- . >/dev/null; then echo "Use SSH (git@github.com:...)"; exit 1; fi'
        language: system
        pass_filenames: false
      - id: forbid-scratch-commits
        name: proibir versionar scratch/
        entry: bash -c 'if git ls-files -- scratch/ | grep -q .; then echo "N√£o versione scratch/"; exit 1; fi'
        language: system
        pass_filenames: false
```

**Instala√ß√£o:**

```bash
pipx install pre-commit || pip install pre-commit
pre-commit install --config .amazonq/.pre-commit-config.yaml --hook-type pre-commit --hook-type commit-msg
```

### 4.2 Commit‚Äëmsg (exigir indica√ß√£o da via) ‚Äî `.amazonq/scripts/check_commit_lane.sh`

```bash
#!/usr/bin/env bash
set -euo pipefail
MSG_FILE="$1"
if ! grep -Eiq '^lane: (rapido|completo)$' "$MSG_FILE"; then
  echo 'Inclua no commit: "lane: rapido" ou "lane: completo" (linha separada).';
  exit 1
fi
```

Adicionar ao pre‚Äëcommit (est√°gio `commit-msg`):

```yaml
  - repo: local
    hooks:
      - id: require-commit-lane
        name: exigir lane no commit
        entry: .amazonq/scripts/check_commit_lane.sh
        language: system
        stages: [commit-msg]
```

**Exemplo de commit (Via R√°pida):**

```git
feat(ui): ajusta label do bot√£o "Salvar"
lane: rapido
```

### 4.3 Template de PR ‚Äî refer√™ncia local (opcional)

```markdown
## Checklist
- [ ] Via **Completa**
- [ ] Plano escrito; execu√ß√£o **ap√≥s** ‚úÖ/aprovado
- [ ] Plano de Testes e **‚úÖ testado ok** (operador)
- [ ] Di√°rio atualizado
- [ ] Sem `scratch/` versionado
- [ ] Sem `https://github.com` (SSH only)

> Marque o PR com o **label**: `lane: full`

## Plano
(arquivos, passos, riscos)

## Plano de Testes
(passos + crit√©rios de aceita√ß√£o)
```

### 4.4 CODEOWNERS ‚Äî refer√™ncia local (opcional)

```
* @seu-usuario-github
```

### 4.5 GitHub Action ‚Äî **policy-check** ‚Äî `.amazonq/rules/policy-check.yml` (refer√™ncia local)

```yaml
name: policy-check
on:
  pull_request:
    branches: [ main ]
permissions:
  contents: read
  pull-requests: write
  issues: read
jobs:
  policy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Diff da base
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          echo "files=$(git diff --name-only FETCH_HEAD...HEAD | tr '
' ' ' )" >> $GITHUB_OUTPUT
      - name: Proibir HTTPS do GitHub
        run: |
          if git grep -n "https://github.com/" -- . >/dev/null; then
            echo "Use SSH (git@github.com:...)"; exit 1; fi
      - name: Proibir scratch/ versionado
        run: |
          CHANGED="${{ steps.diff.outputs.files }}"
          echo "$CHANGED" | tr ' ' '
' | grep '^scratch/' && { echo 'N√£o versione scratch/'; exit 1; } || true
      - name: Bloquear .amazonq na main
        if: github.base_ref == 'main'
        run: |
          echo "${{ steps.diff.outputs.files }}" | tr ' ' '
' | grep '^.amazonq/' && { echo '.amazonq/ deve ficar na dev'; exit 1; } || true
      - name: Exigir atualiza√ß√£o do Di√°rio quando h√° c√≥digo
        run: |
          CHANGED_FILES=$(echo "${{ steps.diff.outputs.files }}" | tr ' ' '
')
          CODE_CHANGED=$(echo "$CHANGED_FILES" | grep -E '\.(py|ts|tsx|js|sh|go|rs)$' || true)
          if [ -n "$CODE_CHANGED" ]; then
            echo "$CHANGED_FILES" | grep -q "^\.amazonq/rules/diario_de_bordo.md$" || { echo 'Atualize o Di√°rio'; exit 1; }
          fi
      - name: Exigir token de aprova√ß√£o de implementa√ß√£o (coment√°rios)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          gh api repos/$REPO/issues/$PR/comments --paginate | jq -r '.[].body' | grep -Ei '(^| )‚úÖ($| )|aprovado' >/dev/null || {
            echo '√â necess√°rio coment√°rio de aprova√ß√£o (‚úÖ/aprovado).'; exit 1; }
      - name: Exigir **label** de via completa
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          gh pr view $PR --repo $REPO --json labels -q '.labels[].name' | grep -Fx 'lane: full' >/dev/null || {
            echo 'Adicione o label do PR: "lane: full" (PRs s√£o s√≥ para via completa ou quando solicitados).'; exit 1; }
      - name: Exigir aprova√ß√£o de testes do operador (PR body)
        run: |
          BODY='${{ github.event.pull_request.body }}'
          echo "$BODY" | grep -Ei '(‚úÖ testado ok|aprovado para PR)' >/dev/null || {
            echo 'Inclua no corpo do PR a aprova√ß√£o de testes do operador (‚úÖ testado ok / aprovado para PR).'; exit 1; }
```

> Observa√ß√£o: este workflow s√≥ atua **em PRs para `main`**. Na **Via R√°pida**, como n√£o h√° PR por padr√£o, o enforcement fica **local** (pre‚Äëcommit + disciplina de Di√°rio).

---

## 5) Quick‚Äëcheck local ‚Äî `.amazonq/scripts/quick_check.sh`

```bash
#!/usr/bin/env bash
set -euo pipefail

# Lint/format
if command -v ruff >/dev/null 2>&1; then ruff .; fi
if command -v black >/dev/null 2>&1; then black --check . || true; fi

# Testes (se existir pytest)
if command -v pytest >/dev/null 2>&1; then pytest -q || { echo '‚ùå Testes falharam'; exit 1; }; else
  echo '‚ö†Ô∏è  pytest n√£o encontrado ‚Äî execu√ß√£o apenas de lint/format.'
fi

echo '‚úÖ Quick-check ok'
```

---

## 6) `.gitignore`

```gitignore
scratch/
*.tmp
*.tmp.*
.q-cache/
```

---

## 7. Verifica√ß√£o p√≥s‚Äëmerge (apenas Via Completa) ‚Äî `scripts/verifica_auto_merge.sh`

```bash
#!/usr/bin/env bash
set -euo pipefail
REPO="$(gh repo view --json nameWithOwner -q .nameWithOwner)"
PR_NUMBER="${1:-$(gh pr view --json number -q .number)}"
echo "Checando PR #$PR_NUMBER em $REPO..."
for i in {1..40}; do
  STATE=$(gh pr view "$PR_NUMBER" --json state -q .state)
  MERGED_AT=$(gh pr view "$PR_NUMBER" --json mergedAt -q .mergedAt)
  if [ "$STATE" = "MERGED" ] && [ -n "$MERGED_AT" ]; then
    echo "‚úÖ Auto-merged em $MERGED_AT"; exit 0; fi
  echo "Aguardando auto-merge‚Ä¶ ($i)"; sleep 15
done

gh pr view "$PR_NUMBER" --json state,mergeable,mergeStateStatus,headRefName,baseRefName | jq .
echo "‚ùå N√£o houve auto-merge. Verifique CI/prote√ß√µes e volte ao passo 2 (Investigar)."
exit 1
```

---

## 8. Anti‚Äësinais de IA & identidade do autor

**Prop√≥sito**: n√£o dar pinta de IA e garantir que **toda autoria** apare√ßa no **seu nome**.

### Regras pr√°ticas

* **Commits**: sempre **curtos e pr√°ticos em portugu√™s** (assunto ‚â§ 72 caracteres, sem ponto final). Evite frases de IA (ex.: ‚Äúauto-generated‚Äù, ‚Äúgenerated by‚Äù, ‚Äúagent‚Äù, ‚ÄúAI assistant‚Äù, ‚ÄúChatGPT‚Äù, ‚ÄúCopilot‚Äù, ‚ÄúAmazon Q‚Äù, ‚ÄúLLM‚Äù).
* **C√≥digo leg√≠vel**: estruturas simples, fun√ß√µes curtas, nomes claros. **Sem coment√°rios prolixos** ou colar prompts.
* **Coment√°rios de linha**: usar `//comentario` **sem espa√ßo** ap√≥s `//` (ex.: `//ok`, n√£o `// ok`).
* **Identidade**: usar **Git/GitHub CLI** sempre no seu usu√°rio para commits/PRs (nada de ‚Äúagent tal‚Äù).

### Configura√ß√£o recomendada (uma vez)

```bash
git config --global user.name "SEU_NOME"
git config --global user.email "seu@email"
# GitHub CLI
gh auth login
```

---

## 8. Resumo visual

```
VIA R√ÅPIDA: Checkpoint ‚Üí Mini-investiga√ß√£o/Plano ‚Üí ‚úÖ breve ‚Üí Implementar ‚Üí Quick-check ‚Üí Di√°rio ‚Üí (sem PR por padr√£o)

VIA COMPLETA: Checkpoint ‚Üí Investigar ‚Üí Plano ‚Üí üõë Aprova√ß√£o ‚Üí Executar ‚Üí Di√°rio ‚Üí üß™ Teste + ‚úÖ do operador ‚Üí PR ‚Üí CI/Auto‚Äëmerge ‚Üí Verifica√ß√£o GH CLI ‚Üí Resumo
```
