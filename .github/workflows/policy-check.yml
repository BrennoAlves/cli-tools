name: policy-check
on:
  pull_request:
    branches: [ main ]
permissions:
  contents: read
  pull-requests: write
  issues: read
jobs:
  policy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Diff da base
        id: diff
        run: |
          set -euo pipefail
          BASE_SHA='${{ github.event.pull_request.base.sha }}'
          HEAD_SHA='${{ github.event.pull_request.head.sha }}'
          echo "üìÑ Base: $BASE_SHA"; echo "üìÑ Head: $HEAD_SHA"
          FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | tr '\n' ' ')
          echo "Arquivos alterados:"; echo "$FILES" | tr ' ' '\n'
          echo "files=$FILES" >> $GITHUB_OUTPUT
      - name: Echo arquivos alterados
        run: |
          echo "Arquivos do diff:"; echo "${{ steps.diff.outputs.files }}" | tr ' ' '\n'
      - name: Proibir clone via HTTPS do GitHub em arquivos alterados
        run: |
          set -euo pipefail
          CHANGED="${{ steps.diff.outputs.files }}"
          echo "Verificando clone via HTTPS nos arquivos alterados..."
          echo "$CHANGED" | tr ' ' '\n' | while read -r f; do
            [ -f "$f" ] || continue
            if grep -nE "git clone https://github.com/" "$f" >/dev/null; then
              echo "‚ùå HTTPS proibido em: $f (use SSH: git@github.com:usuario/repositorio.git)"; exit 1; fi
          done
          echo "‚úÖ Nenhum comando proibido encontrado."
      - name: Proibir scratch/ versionado
        run: |
          set -euo pipefail
          CHANGED="${{ steps.diff.outputs.files }}"
          echo "$CHANGED" | tr ' ' '\n' | grep '^scratch/' && { echo '‚ùå N√£o versione scratch/'; exit 1; } || echo "‚úÖ Sem scratch/ no diff"
      - name: Bloquear .amazonq na main
        if: github.base_ref == 'main'
        run: |
          set -euo pipefail
          echo "${{ steps.diff.outputs.files }}" | tr ' ' '\n' | grep '^\\.amazonq/' && { echo '‚ùå .amazonq/ deve ficar na dev'; exit 1; } || echo "‚úÖ Sem .amazonq/ no diff"
      - name: Exigir atualiza√ß√£o do Di√°rio quando h√° c√≥digo (apenas fora da main)
        if: github.base_ref != 'main'
        run: |
          CHANGED_FILES=$(echo "${{ steps.diff.outputs.files }}" | tr ' ' '\n')
          CODE_CHANGED=$(echo "$CHANGED_FILES" | grep -E '\\.(py|ts|tsx|js|sh|go|rs)$' || true)
          if [ -n "$CODE_CHANGED" ]; then
            echo "$CHANGED_FILES" | grep -q "^\\.amazonq/rules/diario_de_bordo.md$" || { echo 'Atualize o Di√°rio'; exit 1; }
          fi
      # Regras adicionais podem ser aplicadas via pre-commit local e ruleset organizacional
